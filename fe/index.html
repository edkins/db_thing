<html>
<head>
<script>
'use strict';

function empty(el) {
	while (el.lastChild) {
		el.removeChild(el.lastChild);
	}
}

function td(text) {
	const el = document.createElement('td');
	el.textContent = text;
	return el;
}

function td_el(e) {
	const el = document.createElement('td');
	el.appendChild(e);
	return el;
}

function tr(tds) {
	const el = document.createElement('tr');
	for (const td of tds) {
		el.appendChild(td);
	}
	return el;
}

function link(href, text) {
	const el = document.createElement('a');
	el.href = href;
	el.textContent = text;
	return el;
}

function lookup_ar(data, keys) {
	const rows = [];
	for (const row of data) {
		let match = true;
		for (const key in keys) {
			if (row[key] !== keys[key]) {
				match = false;
			}
		}
		if (match) {
			rows.push(row);
		}
	}
	return rows;
}

async function populate_views() {
	const response = await fetch('/api/admin/sys/view');
	const views = document.getElementById('views');
	empty(views);
	if (response.ok) {
		const d = await response.json();
		for (let row of d.data) {
			const href = `/view.html?app=${row.app}&view=${row.view}`;
			views.appendChild(tr([td(row.app), td_el(link(href, row.view))]));
		}
	}
}

async function populate_postgres_views() {
	const response = await fetch('/api/pg_catalog/view/pg_views');
	const postgres_views = document.getElementById('postgres_views');
	empty(postgres_views);
	if (response.ok) {
		const d = await response.json();
		for (let row of d.data) {
			const href = `/view.html?app=${row.schemaname}&view=${row.viewname}`;
			postgres_views.appendChild(tr([td(row.schemaname), td_el(link(href, row.viewname))]));
		}
	}
}

async function load() {
	await populate_views();
	await populate_postgres_views();
}

async function advance_migration() {
	await fetch('/api/admin/migration/advance', {method:'POST'});
	load();
}

async function retract_migration() {
	await fetch('/api/admin/migration/retract', {method:'POST'});
	load();
}

window.onload = load;

</script>
</head>
<body>
	<div>
	<button onclick="advance_migration()">Advance</button>
	<button onclick="retract_migration()">Retract</button>
	</div>
	<div>
		<h1>Views</h1>
		<table>
			<thead>
				<tr>
					<th>App</th>
					<th>View</th>
				</tr>
			</thead>
			<tbody id="views">
			</tbody>
		</table>
	</div>
	<div>
		<h1>Postgres views</h1>
		<table>
			<thead>
				<tr>
					<th>Schema</th>
					<th>View</th>
				</tr>
			</thead>
			<tbody id="postgres_views">
			</tbody>
		</table>
	</div>
</body>
</html>
